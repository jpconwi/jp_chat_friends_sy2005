<!DOCTYPE html>
<html>
<head>
  <title>Chat with {{ chat_with }}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='chat.css') }}">
</head>
<body>
  <div class="chat-container">
    <div class="chat-header">
      <button onclick="goBack()">‚Üê Back</button>
      <h2>Chatting with {{ chat_with }}</h2>
    </div>

    <div id="messages" class="chat-messages">
      <!-- Chat messages will appear here -->
    </div>

    <div class="chat-input">
      <input id="msg" type="text" placeholder="Type a message" />
      <button onclick="sendMsg()">Send</button>
    </div>
  </div>

  <script>
    const chatWith = "{{ chat_with }}";

    function goBack() {
      window.location.href = "/dashboard";
    }

    async function loadMessages() {
      try {
        const res = await fetch(`/get_messages?with=${chatWith}`);
        const data = await res.json();
        const messagesDiv = document.getElementById("messages");
        messagesDiv.innerHTML = "";

        data.messages.forEach(msg => {
          const div = document.createElement("div");
          div.className = msg.sender === chatWith ? "user-msg" : "admin-msg";
          div.textContent = `${msg.sender}: ${msg.text}`;
          messagesDiv.appendChild(div);
        });

        // Scroll to bottom
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      } catch (e) {
        console.error("Error loading messages", e);
      }
    }

    async function sendMsg() {
      const msgInput = document.getElementById("msg");
      const msg = msgInput.value.trim();
      if (!msg) return;

      await fetch("/send_message", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ to: chatWith, text: msg })
      });

      msgInput.value = "";
      loadMessages();
    }

    // Initial load and auto-refresh every 5 seconds
    loadMessages();
    setInterval(loadMessages, 5000);
  </script>
</body>
</html>
